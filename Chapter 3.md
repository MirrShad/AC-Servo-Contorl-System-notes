# 第三章 交流伺服控制系统中的编程技术
## 3.1 定点CPU的数据Q格式
### 3.1.1 Q格式说明
QX表示小数点位置
Q1表示小数点位于第1位右侧
Q0的数值范围就是一般short的范围1000 0000 0000 0000（补码+1）到0111 1111 1111 1111.是-32768到32767
像Q15的数值范围也是1000 0000 0000 0000到0111 1111 1111 1111但是解析出来就是-1~((0.5) + (0.5)^2 + ... + (0.5)^15)
### 3.1.2 电机采样中电流采样值的Q格式处理
1. 三相电流检测硬件原理
    一般会串联电阻来采样电流，但是在电流比较小的场合会使用霍尔电流传感器，比如ACS712，会将电流转换为电压值
2. 电流采样值的Q8格式处理
    举个例子，实际电流为2A，但是检测到的值512，将电流值放大了256倍，更容易检测
3. Q格式软件处理举例
    举例采用Q格式的话，怎么进行运算
4. 其他电流传感器芯片的实现
    ACS706的电路
## 3.2 PI调节器的数字实现方法
### 3.2.1 模拟PI调节器的数字化
根据离散化的PI调节器的第n拍输出为 
$$u(n) = K_{p}e(n) + \frac{T_{sam}}{\tau}\sum_{i-1}^{n}e(i)$$
其中$T_{sam}$是采样时间，$\tau$是积分分数，实际上$\tau$根本就是人为调试出来的。$\frac{T_{sam}}{\tau}$根本不是根据系统推测出来的定值，而是人为调试出来的，这里把$K_i$特地写成$\frac{T_{sam}}{\tau}$根本没有任何意义  
数字PI调节器有两种算式：位置式和增量式，上面的式子称为增量式，主要优点简单明了。我们可以根据上一次PI调节器的式子于这次PI调节器式子相减能得到增量式
$$\Delta u(n) = u(n) - u(n-1) = K_{p}(e(n)-e(n-1)) + \frac{T_{sam}}{\tau}e(i)$$
所以增量式的公式是
$$u(n) = \Delta u(n) + u(n-1) = K_p(e(n)-e(n-1)) + K_1 e(n) + u(n-1)$$  
位置式算法还必须同事设积分限幅和输出限幅。
### 3.2.2 改进的数字PI算法
常见的改进算法式积分分离算法。偏差大的时候，只让比例部分起作用。偏差降低到一定数值过后，再将积分作用投入。
$$u(k)=K_p e(k) + C_I K_I T_{sam} \sum_{i-1}^{k} e(i)$$
$$\begin{cases} 
		1&&\left | e(i) \right |\leqslant\delta\\
		0&&\left | e(i) \right |>\delta			
	\end{cases}$$
### 3.2.3 数字PI调节器举例
出去积分限幅和输出限幅，以及对Q格式的处理，我们可以简略地缩写三个算法  
```
int ACMR_PI(){
    M_IntK = Mki * error1 + M_IntK;
    Tempm = MKp * error1 + M_IntK;
    return Tempm;
}
```
```
int ACTR_PI(){
    T_IntK = Tki*error2 + T_IntK;
    Tempt2 = Tkp * error2 + T_IntK;
    return Tempt2;
}
```
```
int ASR_PI(){
    S_IntK = Ski*error3+S_IntK;
    Temps = Skp*error3+S_IntK;
    return Temps;
}
```
我们可以看到就是很简单的PI算法，居然用了三个例子来说明，估计是在骗稿费  
关于d-q轴的资料如下，之后会有介绍的，这个不是这章的重点  
https://blog.csdn.net/he_wen_jie/article/details/51106676  
## 3.3 PWM驱动信号
### 3.3.1 三项互补的PWM驱动
这段是关于STM32具体的配置方法，由于未必使用STM32所以就没有继续看下去
### 3.3.2 无刷直流电动机的PWM驱动
不使用无刷直流电机
## 3.4 数字测速
### 3.4.1 旋转编码器
有两相A相和B相是为了辨别方向，两相相差了90度，正转时A相超前B相，反转时B相超前A相。
书中的图3-7的横坐标是时间，所以不应该正转往左看，反转往右看
一般加到4096以上就很难增加光栅数。所以会采用倍频技术，一般会采用4倍频电路，大于4倍频的电路比较难实现。
### 3.4.2 数字测速方法的精度指标
1. 分辨率Q  
被测转速变化是，能引起计数值改变的最小变化
2. 测速误差率$\delta$  
实际转速和测量值之差于实际值之比是测速误差率
### 3.4.3 M法测速
测量一个采样周期内旋转编码器的脉冲个数来算出转速
$$n = \frac{60M_1}{zT_c}$$
n是转速单位是r/min，$M_1$是时间$T_c$内的脉冲个数，z是旋转编码器每转输出的脉冲个数，$T_c$是采样周期，单位为s  
分辨率为 
$$Q = \frac{60(M_1+1)}{zT_c}-\frac{60M_1}{zT_c}=\frac{60}{zT_c}$$
由此可见，分辨率是个定值。  
测速误差率，主要造成误差的地方只可能在采样脉冲和计数脉冲不一致上。所以误差率按照下面式子算出来
$$\delta_{max} \% = \frac{{\frac{60M_1}{zT_c}}-{\frac{60(M_1-1)}{zT_c}}}{\frac{60M_1}{zT_c}}*100\%=\frac{1}{M_1}*100\%$$
由式子我们可以看到误差率和转速有关，转速越低，误差率越大
### 3.4.4 T法测速
通过测量旋转编码器两个输出脉冲之间的间隔时间来算出转速
$$n = \frac{60f_0}{zM_2}$$
n是转速单位是r/min，$M_2$是两个输出脉冲之间的时钟脉冲个数，z是旋转编码器每转输出的脉冲个数。$f_0$是时钟脉冲频率，单位是1/s。  
$M_2/f_0$是旋转编码器两个脉冲输出之间的时钟脉冲时间，然后$\frac{zM_2}{f_0}$是转一圈的时间，然后调整成以分为单位得到结论
分辨率为
$$Q = \frac{60f_0}{zM_2-1} - \frac{60f_0}{zM_2} = \frac{60f_0}{z(M_2-1)M_2}$$
我们可以看到和转速成反比，转速越大，分辨率越低  
同上，主要造成误差的地方只可能在时钟脉冲和两次输出脉冲不一致上
$$\delta_{max} \% = \frac{{\frac{60f_0}{z(M_2-1)}}-{\frac{60(f_0)}{zM_2}}}{\frac{60f_0}{zM_2}}*100\%=\frac{1}{M_2-1}*100\%$$
所以我们可以看到转速越大，误差率越大
### 3.4.5 M/T法测速
M法在高速的时候表现好，T法在高速的时候表现好，M/T法就是用公式将两个方法用到了一起

