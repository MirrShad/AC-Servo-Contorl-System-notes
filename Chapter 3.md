# 第三章 交流伺服控制系统中的编程技术
## 3.1 定点CPU的数据Q格式
### 3.1.1 Q格式说明
QX表示小数点位置
Q1表示小数点位于第1位右侧
Q0的数值范围就是一般short的范围1000 0000 0000 0000（补码+1）到0111 1111 1111 1111.是-32768到32767
像Q15的数值范围也是1000 0000 0000 0000到0111 1111 1111 1111但是解析出来就是-1~((0.5) + (0.5)^2 + ... + (0.5)^15)
### 3.1.2 电机采样中电流采样值的Q格式处理
1. 三相电流检测硬件原理
    一般会串联电阻来采样电流，但是在电流比较小的场合会使用霍尔电流传感器，比如ACS712，会将电流转换为电压值
2. 电流采样值的Q8格式处理
    举个例子，实际电流为2A，但是检测到的值512，将电流值放大了256倍，更容易检测
3. Q格式软件处理举例
    举例采用Q格式的话，怎么进行运算
4. 其他电流传感器芯片的实现
    ACS706的电路
## 3.2 PI调节器的数字实现方法
### 3.2.1 模拟PI调节器的数字化
根据离散化的PI调节器的第n拍输出为 
$$u(n) = K_{p}e(n) + \frac{T_{sam}}{\tau}\sum_{i-1}^{n}e(i)$$
其中$T_{sam}$是采样时间，$\tau$是积分分数，实际上$\tau$根本就是人为调试出来的。$\frac{T_{sam}}{\tau}$根本不是根据系统推测出来的定值，而是人为调试出来的，这里把$K_i$特地写成$\frac{T_{sam}}{\tau}$根本没有任何意义  
数字PI调节器有两种算式：位置式和增量式，上面的式子称为增量式，主要优点简单明了。我们可以根据上一次PI调节器的式子于这次PI调节器式子相减能得到增量式
$$\Delta u(n) = u(n) - u(n-1) = K_{p}(e(n)-e(n-1)) + \frac{T_{sam}}{\tau}e(i)$$
所以增量式的公式是
$$u(n) = \Delta u(n) + u(n-1) = K_p(e(n)-e(n-1)) + K_1 e(n) + u(n-1)$$  
位置式算法还必须同事设积分限幅和输出限幅。
### 3.2.2 改进的数字PI算法
常见的改进算法式积分分离算法。偏差大的时候，只让比例部分起作用。偏差降低到一定数值过后，再将积分作用投入。
$$u(k)=K_p e(k) + C_I K_I T_{sam} \sum_{i-1}^{k} e(i)$$
$$\begin{cases} 
		1&&\left | e(i) \right |\leqslant\delta\\
		0&&\left | e(i) \right |>\delta			
	\end{cases}$$
### 3.2.3 数字PI调节器举例
我们可以简略地缩写三个算法  
'''
M_IntK = Mki * error1 + M_IntK
Tempm = MKp * error1 + M_IntK
'''

https://blog.csdn.net/he_wen_jie/article/details/51106676
